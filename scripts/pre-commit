#!/bin/bash
# Pre-commit hook: 提交前检查代码规范
# 安装: make install-hooks

set -e

# 颜色
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running pre-commit checks...${NC}"

# 检查是否有暂存的文件
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' || true)

# ============================================
# Go 代码检查
# ============================================
if [ -n "$STAGED_GO_FILES" ]; then
    echo -e "\n${YELLOW}[Go] Checking staged files...${NC}"

    # 检查 goimports
    if command -v goimports &> /dev/null; then
        echo "  Running goimports..."
        GOIMPORTS_OUTPUT=$(goimports -local github.com/CoxxA/nomadbank -l $STAGED_GO_FILES 2>&1 || true)
        if [ -n "$GOIMPORTS_OUTPUT" ]; then
            echo -e "${RED}  goimports check failed. Please run:${NC}"
            echo "    goimports -local github.com/CoxxA/nomadbank -w $GOIMPORTS_OUTPUT"
            exit 1
        fi
    else
        echo -e "${YELLOW}  Warning: goimports not found, skipping...${NC}"
        echo "  Install: go install golang.org/x/tools/cmd/goimports@latest"
    fi

    # 检查 go build
    echo "  Running go build..."
    if ! go build ./... 2>&1; then
        echo -e "${RED}  go build failed${NC}"
        exit 1
    fi

    # 检查 golangci-lint (如果安装了)
    if command -v golangci-lint &> /dev/null; then
        echo "  Running golangci-lint..."
        if ! golangci-lint run --new-from-rev=HEAD~1 2>&1; then
            echo -e "${RED}  golangci-lint check failed${NC}"
            exit 1
        fi
    else
        echo -e "${YELLOW}  Warning: golangci-lint not found, skipping...${NC}"
        echo "  Install: https://golangci-lint.run/usage/install/"
    fi

    echo -e "${GREEN}  Go checks passed${NC}"
fi

# ============================================
# 前端代码检查
# ============================================
if [ -n "$STAGED_TS_FILES" ]; then
    echo -e "\n${YELLOW}[Frontend] Checking staged files...${NC}"

    # 进入前端目录
    cd frontend

    # 检查 node_modules 是否存在
    if [ ! -d "node_modules" ]; then
        echo -e "${RED}  node_modules not found. Run: cd frontend && npm install${NC}"
        exit 1
    fi

    # ESLint
    echo "  Running ESLint..."
    if ! npm run lint --silent 2>&1; then
        echo -e "${RED}  ESLint check failed${NC}"
        exit 1
    fi

    # Prettier
    echo "  Running Prettier..."
    if ! npm run format:check --silent 2>&1; then
        echo -e "${RED}  Prettier check failed. Run: npm run format${NC}"
        exit 1
    fi

    # TypeScript
    echo "  Running TypeScript check..."
    if ! npx tsc --noEmit 2>&1; then
        echo -e "${RED}  TypeScript check failed${NC}"
        exit 1
    fi

    cd ..
    echo -e "${GREEN}  Frontend checks passed${NC}"
fi

echo -e "\n${GREEN}All pre-commit checks passed!${NC}"
